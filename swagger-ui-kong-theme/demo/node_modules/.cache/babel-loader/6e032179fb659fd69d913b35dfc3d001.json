{"ast":null,"code":"\"use strict\";\n\nconst util = require(\"../util\");\nconst {\n  ono\n} = require(\"ono\");\nconst ZSchema = require(\"z-schema\");\nconst {\n  openapi\n} = require(\"openapi-schemas\");\nmodule.exports = validateSchema;\nlet zSchema = initializeZSchema();\n\n/**\n * Validates the given Swagger API against the Swagger 2.0 or 3.0 schema.\n *\n * @param {SwaggerObject} api\n */\nfunction validateSchema(api) {\n  // Choose the appropriate schema (Swagger or OpenAPI)\n  let schema = api.swagger ? openapi.v2 : openapi.v3;\n\n  // Validate against the schema\n  let isValid = zSchema.validate(api, schema);\n  if (!isValid) {\n    let err = zSchema.getLastError();\n    let message = \"Swagger schema validation failed. \\n\" + formatZSchemaError(err.details);\n    throw ono.syntax(err, {\n      details: err.details\n    }, message);\n  }\n}\n\n/**\n * Performs one-time initialization logic to prepare for Swagger Schema validation.\n */\nfunction initializeZSchema() {\n  // HACK: Delete the OpenAPI schema IDs because ZSchema can't resolve them\n  delete openapi.v2.id;\n  delete openapi.v3.id;\n\n  // The OpenAPI 3.0 schema uses \"uri-reference\" formats.\n  // Assume that any non-whitespace string is valid.\n  ZSchema.registerFormat(\"uri-reference\", value => value.trim().length > 0);\n\n  // Configure ZSchema\n  return new ZSchema({\n    breakOnFirstError: true,\n    noExtraKeywords: true,\n    ignoreUnknownFormats: false,\n    reportPathAsArray: true\n  });\n}\n\n/**\n * Z-Schema validation errors are a nested tree structure.\n * This function crawls that tree and builds an error message string.\n *\n * @param {object[]}  errors     - The Z-Schema error details\n * @param {string}    [indent]   - The whitespace used to indent the error message\n * @returns {string}\n */\nfunction formatZSchemaError(errors, indent) {\n  indent = indent || \"  \";\n  let message = \"\";\n  for (let error of errors) {\n    message += util.format(`${indent}${error.message} at #/${error.path.join(\"/\")}\\n`);\n    if (error.inner) {\n      message += formatZSchemaError(error.inner, indent + \"  \");\n    }\n  }\n  return message;\n}","map":null,"metadata":{},"sourceType":"script"}